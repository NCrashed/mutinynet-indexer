use serial_test::serial;

use crate::vault::*;

use super::init_parser;

// Open vault tx (height 1807188) $51,052.07 ~ 0.4 998 BTC
// https://mutinynet.com/tx/226b43bad347e7efb1b3b74f42da790f6b9edd2122532be9f801c74bac6d353b
const OPEN_VAULT_TX: &'static str = "0200000000010245c49871f1346a7d3eb09b7920d4932c37e1707ed53de1471f2a23c9cf3669930000000000ffffffff45c49871f1346a7d3eb09b7920d4932c37e1707ed53de1471f2a23c9cf3669930100000000ffffffff0514270000000000002251207017dbe1bf7cbb61a9128e09df3668a433a023955e3e437565678dd2f976ed15102700000000000022512078bce6e3cd5174f61b1e1842bbc7e3d1996cef722921bddb2c1d5a6183207e5360a2fa0200000000225120966b6d21f7682f726822746b06046e0e56f32662bd0df3510bfd751d31f60f7a64b0fa0200000000160014d4fb54d79bd7a09108010b85de3ec242523c71b80000000000000000116a580e016f000183166797d7d90015413801406417715c10b9a4dab4585ee747ca13d24c9ff3339c54cebbc903bed35760c5b87d40f609091674c8e0411eb6539ee3d648e72b264eb7ec1415e1756466f7310f034092ac7a004089a0e8ae9803ca3c449e056dd32ba8fd0bb2bf8dd32f3f9a7ef16bc40a4b7605d2bfb37185b554f0c2e10e6b9ad5dac3f538306b6e7d2e91489f9efd3f012027088af775e886db3b4b51eb5289f7aee333ba22716ed98cdb0337c5073c9164ac0063036f726451106170706c69636174696f6e2f6a736f6e52021427004c6d7b22636174223a313733383030343434342c22726576223a302c22746167223a2231222c2276706b223a2232373038386166373735653838366462336234623531656235323839663761656533333362613232373136656439386364623033333763353037336339313634227d680063036f726451106170706c69636174696f6e2f6a736f6e5202244e5321a056e585ebe23726fc7bf4fbc86ad6e88d4d54ec7c9036063bfa2808f5ddc16205004c4d7b227075626b6579223a2232373038386166373735653838366462336234623531656235323839663761656533333362613232373136656439386364623033333763353037336339313634227d6821c150929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac000000000";

// Deposit tx (height 1810900) $3,073.3 ~ 0.03 006 697 BTC
// https://mutinynet.com/tx/6d45fa47d7c2116bb44b6f42a2993ce7f985f35cd651d3500bf0f5e76724068c
const DEPOSIT_TX: &'static str = "02000000000102b677cba459b67c74306716271ef62309aa2510344b038b9b7884c05bcc4b2f350000000000ffffffff3c174c33fdf110e5587a1826f6b2672f4e35352a8180f94da74efb713eb42bca010000001716001457524de62f0d5d9e26ffdb41287ce88f9cd0f8c5ffffffff030382dc0000000000225120871d4361695a7ee4eef0d85cdc0f558fc9eb9265ed7031f5c66cf8b030f583f2aad102000000000017a91442089c960c685a1e29a64e0e69b707ccef8fb42d870000000000000000116a580e016400018d40679999c90003033f04401367fe4a997f3db9bddd53685d7317f74aa7baff8dcc46be2f5ba184f15dbbbba055e5369517318d614f44f246b6695d99f7c1964de114457cdba9a9290d3d56404b1bf0d94f3ae886eea33869d8163e1a08eb207dd4babb53f86a2ef482fa660e16a7ee50f3f6cc14de0680fb6f12d4004191f394616f0642b7947a516f827f6b4420d633f4267ea08d94114f586b613ed4ea7517ee30b63a17bd00f7a07e25114aa0ad20604cb84df7bb174100d3b9385ac9b24ecf6e8c444833248a6f18ecb157440ae5ac41c150929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac03bb4182673b9f28abc36b34cf1138743543cb41317159eb6216826149cd064cc0247304402202dee1ce597bea70bffc9e9e329d6c7935ee5b58022669448814be37232cc6f24022021107c7258439e567cd39489b47d30b813873cf0791a532107af58e060aa75ae012102c2d81859351e3837b8b986cf9a457bc5b1db6816611abbd19df3dc7a3bb76b5700000000";

// Withdraw tx (height 1810897) $2,775.97 ~ 0.02 715 815 BTC
// https://mutinynet.com/tx/352f4bcc5bc084789b8b034b341025aa0923f61e27166730747cb659a4cb77b6
const WITHDRAW_TX: &'static str = "0200000000010142adf81b693c96959c39dfa8fc1141d218c2d4dbd770e89848b3c12827ee3b6c0000000000ffffffff031aa1ae0000000000225120871d4361695a7ee4eef0d85cdc0f558fc9eb9265ed7031f5c66cf8b030f583f2976729000000000017a91442089c960c685a1e29a64e0e69b707ccef8fb42d870000000000000000116a580e017700018d40679999800003033f0440366c71f66b7bc8b7e0b52aaebf24be66f4a0faba23efc46e192cafd299b6bce7f9a833c4fce59eec6d7b828adbb59a9c78f7b6c914b8f8d1efb9acf5b020c0944032b56df752ac75819b60d7fd4ecbc12d9e2518463ec90583b01c8e09b99f3ca3ee45a40a679bb59cc5e1706cdda21a0460b26e3fa4e5a891fc1e64509217d6c84420d633f4267ea08d94114f586b613ed4ea7517ee30b63a17bd00f7a07e25114aa0ad20604cb84df7bb174100d3b9385ac9b24ecf6e8c444833248a6f18ecb157440ae5ac41c150929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac03bb4182673b9f28abc36b34cf1138743543cb41317159eb6216826149cd064cc00000000";

// Repay tx (height 1810944) $27,000 ~ 27,000 UNIT
// https://mutinynet.com/tx/f96b39cb34410c642c81461498a2e97c698d38d76ae813deb5ff071332c18138
const REPAY_TX: &'static str = "020000000001026ecd9b9aa19ec5f7157ced55b520064aa30f56ec354bffa63571460287d1bd910000000000ffffffffff699be6d0174d9486674a733a0c0ba1cf1950f79066e69372d6469ce426f6b40100000000ffffffff03710d4f0400000000225120cc5fc0902b7566afce9a6a0754ca44fe4fa931a826f0c965e9eb36983d4c48f18b715b000000000017a91495eed73180fa42104e91ff5bcc469be972d8bc72870000000000000000116a580e017200018e1367999f2200000000044057bc3ed1c26e9ad1e4ee53304e6c9c7a675b5edb112d84cdd574f802e01d1b29c8b50193c4d9aac2be7e33dc62210d4a4764fb3a7a344acd5bf1d24bd8ec61dd4047525c92345e70e6eb7d89e4080997126e47eb98631ed48825f7454b531302660c96797033851161f77f17cd9a2b145897d1076169c3063e02019a3fd8a4bb89442009491bc8f182b9d0bacedc43adeb60b4284b12c69a1da663fb5ab215b46bfc34ad20604cb84df7bb174100d3b9385ac9b24ecf6e8c444833248a6f18ecb157440ae5ac41c050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac03bb4182673b9f28abc36b34cf1138743543cb41317159eb6216826149cd064cc044043b5aef823b0e411d2c89a99dd1850c40f71ba913fd8ba861feaf381a2cbeab974248566eec3d941a506d5d2acef14415a414694579559cc5b8a5f471c6c6d7140f03dd416f72bd77eaf04b92d05ef3f1943a4ca338c6f6ec7fb1642cd8466b187f3413c8fe6971c7c892e1d536804085153d96682b636f467943e4ce75546c859442009491bc8f182b9d0bacedc43adeb60b4284b12c69a1da663fb5ab215b46bfc34ad20604cb84df7bb174100d3b9385ac9b24ecf6e8c444833248a6f18ecb157440ae5ac21c050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac000000000";

// Borrow tx (height 1810671) $1,983.66 ~ 1,983.66 UNIT
// https://mutinynet.com/tx/f2e73cd88d831674670d2c02bd666ebd8666bf88cfb499ba015f797335754132
const BORROW_TX: &'static str = "020000000001023423c562fcd52239a5d0a1cbdadbd19de89ed88e7b83e2bf7f7929262fec00b40000000000fffffffff9daef83f70e95136f7a33bd63242f1b4aacc2c5d94bfb4950aa27b7bba3a9870100000000ffffffff033b83ea0000000000225120871d4361695a7ee4eef0d85cdc0f558fc9eb9265ed7031f5c66cf8b030f583f29aff0f000000000017a91442089c960c685a1e29a64e0e69b707ccef8fb42d870000000000000000116a580e016200018df8679996390005da230440d35489705088f52f6d17d4a84f7e0f1878b94d9d65d4a6d8184e10401622854444bcc0e0ca3d00d4ff7c6aac2e99dc1da27c5e5a822be08ce4655b1807ef0ba340214c5061daee594f0ca2f581b96acccd3ccbd78d7749bd8fb012a275bc9fd450265248df0071b130e0c0f55a779d5496eeb638dfce5b0006025c87af71d7792f4420d633f4267ea08d94114f586b613ed4ea7517ee30b63a17bd00f7a07e25114aa0ad20604cb84df7bb174100d3b9385ac9b24ecf6e8c444833248a6f18ecb157440ae5ac41c150929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac03bb4182673b9f28abc36b34cf1138743543cb41317159eb6216826149cd064cc044095662c057636b4a8d011011fa8fd183c11079800b69e8ff09d732f2ca31d86989ba7ccc8faf60f5bf50b3de1f5b024fab22ac2fed8fa7c7cf2c8549b6da9be474035312448a784bee2cc822239378017db2f5ea2ddd6923733af6c6459410ba7671fddb3d46f2fa9ed89789850a5b97ad6bca97ed54cb87e488ce28969a3d6890a4420d633f4267ea08d94114f586b613ed4ea7517ee30b63a17bd00f7a07e25114aa0ad20604cb84df7bb174100d3b9385ac9b24ecf6e8c444833248a6f18ecb157440ae5ac21c050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac000000000";

//
// https://mutinynet.com/tx/2108fc95cad48ef94a6a103e11bdeeaaf23a7ce9433804c5b0eb4e978b7aac99
const UNKNOWN_VAULT_TX: &'static str = "02000000000102c7136887ecb61a29bde2b2709ce3f6aa6995b3b41bdaf16cfcc41a5d1c3d6dff0000000000ffffffffc7136887ecb61a29bde2b2709ce3f6aa6995b3b41bdaf16cfcc41a5d1c3d6dff0100000000ffffffff051427000000000000225120da4ec4d4c127e1795120b504bd777e42961a406a2b0d9d6e860ce3e6e26599e41027000000000000225120756939bba0cc7bf3ebf4d3cc89afb00314a48068de61df1e35cebfc35f27eff7807ff80200000000225120a1e3299583843d3bc7f06d609a495ca8f43364320a1fc4bd79416f4718f4d38524cffc020000000016001457a667f4a2988afb6f4f721a1d41c36f642f13360000000000000000296a5826016f0030c629000190d7679a038a00009c40d9ceb8f426ae2006a5224f263433e035430cfbad0140f21f943fd1559f58e0eca398ac1119073366b462d74c3e7160b109df914dad1d5b734e3940ea584565415c7b4edd8a29601dad97ab485550b64a9508f68f166b0440ae66d303c50bb3aba4b141d442c934d1a67f4cf97fb9063c1c47120a3f04dba0721beb26626ba8e258584049d52c8227a6d0a3e5eb3f4fa6f5b3d5f57899b900403d309b636acb65cdb553e022bd62be4def26c83fdfa7017164cb7c45b9fe9600a36d02283fd9c31dca1ad1de304b389b2a6da903e6a464263f6979542712764ffdab01206e61c63538d5e30c8a58e53f0bd1b5437c175aa0e9d7ee51a864327b8aea3be9ad20da4ec4d4c127e1795120b504bd777e42961a406a2b0d9d6e860ce3e6e26599e4ac0063036f726451106170706c69636174696f6e2f6a736f6e52021427001f7b22726576223a302c22746167223a224c75636173222c22766572223a317d680063036f726451106170706c69636174696f6e2f6a736f6e5202244e5321e01170a477e12a8a980bd3465ef4fd13f68c7a63ef9c8fc7e7b22f8ba3d4a16401004ce67b2267706b223a2264613465633464346331323765313739353132306235303462643737376534323936316134303661326230643964366538363063653365366532363539396534222c226d6964223a22386638363630653937343434396561623565633434643461383736376465393930393765613162643539353466336138343766343530306663643837353033646930222c2276706b223a2236653631633633353338643565333063386135386535336630626431623534333763313735616130653964376565353161383634333237623861656133626539222c22766572223a317d6821c150929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac000000000";

// Coinbase tx with op return to test negative case
// https://mutinynet.com/tx/47233bde6d8c36956286f97651c7e914ea269c6b1766b9e3e2b7edbb03a61c93
const OTHER_OPRETURN_TX: &'static str = "020000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff0403d1a11bfeffffff02020f2a01000000001600146a8f30e42f81d23c6e24f34c0ecad822b757e4900000000000000000776a24aa21a9edeccfb19cf6b2d78e31d3b6271e1908c4309fd045f7a603fe847d32757cc401a64c4fecc7daa2490047304402203feff7bb9d5e55c8986d5c557dd8ebeaced78e77a15658fe047f90a29f2dcffb022070088299c6b7fad50faad25120df378bb87c3b014d42b8808d7ccbd4be7ef4fa01000120000000000000000000000000000000000000000000000000000000000000000000000000";

// Non op_return transaction to test negative case
// https://mutinynet.com/tx/0f5a81cee36223a5c6a95ddd8f09f7df9276a8655410ce099395dcaa15c86e4f
const OTHER_UNRELATED_TX: &'static str = "010000000001013e8c75f71ccdd199d6501bec19e52c5db62a58a362e0dfc8b8e44cd7a72d2eba0100000000ffffffff0240420f00000000002251208e52c76edaee5cfa9f7f49c9af8ef4fa8e3f475501df6dd0d58b1b5666aefcf832750dc9000000002251207a190f84305b4b9294f510ab0d14bdde95723c227f5096c18cd7b6a31a0a0b050140e894cf8a24396512bc9cfa971243001b004af85b5fe39d681852208e0de62438f69db6354d23938c39d000ec4e66a7315d96cf1e338d934552dac318cb0c3b0b00000000";

#[test]
#[serial]
fn parse_other_opreturn() {
    init_parser();

    let tx_bytes = hex::decode(OTHER_OPRETURN_TX).unwrap();
    let result = VaultTx::from_bytes(&tx_bytes);
    if let Err(TxParseError::NotVaultTx(reason)) = result {
        assert_eq!(reason, VaultParseError::MismatchOpPush8(36));
    } else {
        panic!("Expected error at parsing: {result:?}");
    };
}

#[test]
#[serial]
fn parse_other_unrelated() {
    init_parser();

    let tx_bytes = hex::decode(OTHER_UNRELATED_TX).unwrap();
    let result = VaultTx::from_bytes(&tx_bytes);
    if let Err(TxParseError::NotVaultTx(reason)) = result {
        assert_eq!(reason, VaultParseError::NoOpReturn);
    } else {
        panic!("Expected error at parsing: {result:?}");
    };
}

#[test]
#[serial]
fn parse_open_vault() {
    init_parser();

    let tx_bytes = hex::decode(OPEN_VAULT_TX).unwrap();
    let parsed = VaultTx::from_bytes(&tx_bytes).expect("valid vault tx");
    assert_eq!(parsed.version, VaultVersion::Vault1Legacy);
    assert_eq!(parsed.action, VaultAction::Open);
    assert_eq!(parsed.balance, 1392952);
    assert_eq!(parsed.oracle_price, 99094);
    assert_eq!(parsed.oracle_timestamp, 1738004441);
    assert_eq!(parsed.liquidation_price, None);
    assert_eq!(parsed.liquidation_hash, None);
}

#[test]
#[serial]
fn parse_deposit() {
    init_parser();

    let tx_bytes = hex::decode(DEPOSIT_TX).unwrap();
    let parsed = VaultTx::from_bytes(&tx_bytes).expect("valid vault tx");
    assert_eq!(parsed.version, VaultVersion::Vault1Legacy);
    assert_eq!(parsed.action, VaultAction::Deposit);
    assert_eq!(parsed.balance, 197439);
    assert_eq!(parsed.oracle_price, 101696);
    assert_eq!(parsed.oracle_timestamp, 1738119625);
    assert_eq!(parsed.liquidation_price, None);
    assert_eq!(parsed.liquidation_hash, None);
}

#[test]
#[serial]
fn parse_withdraw() {
    init_parser();

    let tx_bytes = hex::decode(WITHDRAW_TX).unwrap();
    let parsed = VaultTx::from_bytes(&tx_bytes).expect("valid vault tx");
    assert_eq!(parsed.version, VaultVersion::Vault1Legacy);
    assert_eq!(parsed.action, VaultAction::Withdraw);
    assert_eq!(parsed.balance, 197439);
    assert_eq!(parsed.oracle_price, 101696);
    assert_eq!(parsed.oracle_timestamp, 1738119552);
    assert_eq!(parsed.liquidation_price, None);
    assert_eq!(parsed.liquidation_hash, None);
}

#[test]
#[serial]
fn parse_repay() {
    init_parser();

    let tx_bytes = hex::decode(REPAY_TX).unwrap();
    let parsed = VaultTx::from_bytes(&tx_bytes).expect("valid vault tx");
    assert_eq!(parsed.version, VaultVersion::Vault1Legacy);
    assert_eq!(parsed.action, VaultAction::Repay);
    assert_eq!(parsed.balance, 0);
    assert_eq!(parsed.oracle_price, 101907);
    assert_eq!(parsed.oracle_timestamp, 1738120994);
    assert_eq!(parsed.liquidation_price, None);
    assert_eq!(parsed.liquidation_hash, None);
}

#[test]
#[serial]
fn parse_borrow() {
    init_parser();

    let tx_bytes = hex::decode(BORROW_TX).unwrap();
    let parsed = VaultTx::from_bytes(&tx_bytes).expect("valid vault tx");
    assert_eq!(parsed.version, VaultVersion::Vault1Legacy);
    assert_eq!(parsed.action, VaultAction::Borrow);
    assert_eq!(parsed.balance, 383523);
    assert_eq!(parsed.oracle_price, 101880);
    assert_eq!(parsed.oracle_timestamp, 1738118713);
    assert_eq!(parsed.liquidation_price, None);
    assert_eq!(parsed.liquidation_hash, None);
}

#[test]
#[serial]
fn parse_unknown() {
    init_parser();

    let tx_bytes = hex::decode(UNKNOWN_VAULT_TX).unwrap();
    let parsed = VaultTx::from_bytes(&tx_bytes).expect("valid vault tx");
    assert_eq!(parsed.version, VaultVersion::Vault1);
    assert_eq!(parsed.action, VaultAction::Open);
    assert_eq!(parsed.balance, 3196457);
    assert_eq!(parsed.oracle_price, 102615);
    assert_eq!(parsed.oracle_timestamp, 1738146698);
    assert_eq!(parsed.liquidation_price, Some(40000));
    assert_eq!(
        parsed.liquidation_hash,
        Some(
            hex::decode("d9ceb8f426ae2006a5224f263433e035430cfbad")
                .unwrap()
                .try_into()
                .unwrap()
        )
    );
}
